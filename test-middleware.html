<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Middleware - Galeria Assinantes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #005a87;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Teste de Middleware - Galeria Assinantes</h1>
    
    <div class="test-section">
        <h2>1. Configurar Cookies de Autentica√ß√£o</h2>
        <p>Simula um usu√°rio autenticado com assinatura ativa:</p>
        <button onclick="setAuthenticatedCookies()">‚úÖ Definir Como Autenticado com Assinatura</button>
        <button onclick="setUnauthenticatedCookies()">‚ùå Definir Como N√£o Autenticado</button>
        <button onclick="setNoSubscriptionCookies()">‚ö†Ô∏è Autenticado SEM Assinatura</button>
        <div id="cookieStatus" class="status warning">
            <strong>Status atual dos cookies:</strong>
            <div id="cookieDisplay"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>2. Testar Acesso √† Galeria</h2>
        <p>Tenta acessar a p√°gina protegida:</p>
        <button onclick="testGaleriaAccess()">üîç Testar Acesso √† Galeria</button>
        <div id="accessStatus" class="status warning">
            <strong>Resultado do teste:</strong>
            <div id="accessResult">Clique no bot√£o para testar</div>
        </div>
    </div>

    <div class="test-section">
        <h2>3. Informa√ß√µes de Debug</h2>
        <button onclick="showDebugInfo()">üîß Mostrar Debug</button>
        <div id="debugInfo" class="status warning">
            <div id="debugDisplay">Clique para ver informa√ß√µes de debug</div>
        </div>
    </div>

    <script>
        function setAuthenticatedCookies() {
            // Define cookies que simulam usu√°rio autenticado com assinatura
            document.cookie = 'isAuthenticated=true; path=/; max-age=86400';
            document.cookie = 'hasSubscription=true; path=/; max-age=86400';
            
            // Define tamb√©m no localStorage para compatibilidade
            localStorage.setItem('isAuthenticated', 'true');
            localStorage.setItem('hasSubscription', 'true');
            localStorage.setItem('userEmail', 'test@example.com');
            
            updateCookieDisplay();
            showStatus('cookieStatus', 'success', '‚úÖ Usu√°rio configurado como autenticado COM assinatura');
        }

        function setUnauthenticatedCookies() {
            // Remove todos os cookies de autentica√ß√£o
            document.cookie = 'isAuthenticated=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT';
            document.cookie = 'hasSubscription=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT';
            
            // Remove do localStorage
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('hasSubscription');
            localStorage.removeItem('userEmail');
            
            updateCookieDisplay();
            showStatus('cookieStatus', 'error', '‚ùå Usu√°rio configurado como N√ÉO autenticado');
        }

        function setNoSubscriptionCookies() {
            // Define apenas autentica√ß√£o, sem assinatura
            document.cookie = 'isAuthenticated=true; path=/; max-age=86400';
            document.cookie = 'hasSubscription=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT';
            
            localStorage.setItem('isAuthenticated', 'true');
            localStorage.removeItem('hasSubscription');
            localStorage.setItem('userEmail', 'test@example.com');
            
            updateCookieDisplay();
            showStatus('cookieStatus', 'warning', '‚ö†Ô∏è Usu√°rio autenticado SEM assinatura');
        }

        function updateCookieDisplay() {
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                if (key && (key === 'isAuthenticated' || key === 'hasSubscription')) {
                    acc[key] = value || 'n√£o definido';
                }
                return acc;
            }, {});
            
            const display = document.getElementById('cookieDisplay');
            display.innerHTML = `
                <strong>Cookies:</strong><br>
                ‚Ä¢ isAuthenticated: ${cookies.isAuthenticated || 'n√£o definido'}<br>
                ‚Ä¢ hasSubscription: ${cookies.hasSubscription || 'n√£o definido'}<br>
                <strong>LocalStorage:</strong><br>
                ‚Ä¢ isAuthenticated: ${localStorage.getItem('isAuthenticated') || 'n√£o definido'}<br>
                ‚Ä¢ hasSubscription: ${localStorage.getItem('hasSubscription') || 'n√£o definido'}<br>
                ‚Ä¢ userEmail: ${localStorage.getItem('userEmail') || 'n√£o definido'}
            `;
        }

        async function testGaleriaAccess() {
            showStatus('accessStatus', 'warning', 'üîç Testando acesso...');
            
            try {
                const response = await fetch('/galeria-assinantes', {
                    method: 'GET',
                    credentials: 'include', // Inclui cookies na requisi√ß√£o
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                    }
                });
                
                const resultDiv = document.getElementById('accessResult');
                
                if (response.redirected) {
                    showStatus('accessStatus', 'error', 
                        `‚ùå REDIRECIONADO: ${response.url}<br>
                         Status: ${response.status}<br>
                         Middleware funcionou corretamente!`);
                } else if (response.ok) {
                    const text = await response.text();
                    if (text.includes('Galeria Exclusiva')) {
                        showStatus('accessStatus', 'success', 
                            `‚úÖ ACESSO PERMITIDO<br>
                             Status: ${response.status}<br>
                             P√°gina carregada com sucesso`);
                    } else {
                        showStatus('accessStatus', 'warning', 
                            `‚ö†Ô∏è RESPOSTA INESPERADA<br>
                             Status: ${response.status}<br>
                             Conte√∫do n√£o √© a galeria esperada`);
                    }
                } else {
                    showStatus('accessStatus', 'error', 
                        `‚ùå ERRO HTTP: ${response.status}<br>
                         ${response.statusText}`);
                }
            } catch (error) {
                showStatus('accessStatus', 'error', 
                    `‚ùå ERRO DE REDE: ${error.message}`);
            }
        }

        function showDebugInfo() {
            const debugDiv = document.getElementById('debugDisplay');
            debugDiv.innerHTML = `
                <strong>URL atual:</strong> ${window.location.href}<br>
                <strong>User Agent:</strong> ${navigator.userAgent}<br>
                <strong>Timestamp:</strong> ${new Date().toISOString()}<br>
                <strong>Todos os cookies:</strong> ${document.cookie || 'nenhum'}<br>
                <strong>LocalStorage keys:</strong> ${Object.keys(localStorage).join(', ')}<br>
                <strong>Protocolo:</strong> ${window.location.protocol}
            `;
            
            showStatus('debugInfo', 'warning', 'Informa√ß√µes de debug atualizadas');
        }

        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            
            if (elementId === 'accessStatus') {
                document.getElementById('accessResult').innerHTML = message;
            } else if (elementId === 'cookieStatus') {
                updateCookieDisplay();
            }
        }

        // Atualizar display inicial
        window.onload = function() {
            updateCookieDisplay();
        };
    </script>
</body>
</html>
